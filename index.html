<!-- ì´ê²Œ ì œì¼ ê·¼ì ‘(ì—¬ê¸°ì„œ ê°œì„ í•©ì‹œë‹¤.) -->

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë¨¸ë©”ì´ë“œ ë¦¬ë” â€“ ê¹ƒ ì»¤ë°‹ í…ŒìŠ¤íŠ¸ 2</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mermaid -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>

  <!-- canvg (UMD ë¹Œë“œ â†’ window.canvg ê°ì²´ ì œê³µ) -->
  <script src="https://cdn.jsdelivr.net/npm/canvg@4/dist/browser/canvg.min.js"></script>

  <style>
    :root { --padding: 50px; }
    .editor-container { height: calc(100vh - 80px); }
    .editor-sidebar { overflow-y: auto; border-right: 1px solid #e5e7eb; }
    .preview-container { overflow: auto; background:#f9fafb; position:relative; }
    .preview-content{ min-height:100%; padding:2rem; display:flex; align-items:flex-start; justify-content:flex-start; transform-origin:top left; }
    #mermaidOutput{ min-width:100%; min-height:100%; display:inline-block; }
    #mermaidOutput svg{ overflow:visible!important; max-width:none!important; height:auto!important; transform-origin:top left; }
    ::-webkit-scrollbar{ width:8px; height:8px; }
    ::-webkit-scrollbar-track{ background:#f1f1f1; }
    ::-webkit-scrollbar-thumb{ background:#888; border-radius:4px; }
    ::-webkit-scrollbar-thumb:hover{ background:#555; }
    .action-panel{ position:fixed; bottom:20px; right:20px; z-index:10; background:white; padding:8px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
  </style>
</head>
<body class="bg-gray-50">
  <!-- í—¤ë” -->
  <header class="bg-white border-b border-gray-200 py-4">
    <div class="container mx-auto px-6">
      <h1 class="text-2xl font-bold text-gray-800">ğŸ§œâ€â™€ï¸ ë¨¸ë©”ì´ë“œ ë¦¬ë” (ê³ í™”ì§ˆ)</h1>
    </div>
  </header>

  <!-- ì—ë””í„° & ë¯¸ë¦¬ë³´ê¸° -->
  <main class="editor-container grid grid-cols-12">
    <!-- ì½”ë“œ ì…ë ¥ -->
    <aside class="col-span-4 editor-sidebar bg-white p-6 space-y-6">
      <section>
        <h2 class="text-lg font-semibold mb-3 text-gray-700">ë¨¸ë©”ì´ë“œ ì½”ë“œ</h2>
        <textarea id="mermaidInput" class="w-full h-64 p-4 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500"></textarea>
      </section>

      <section class="space-y-3">
        <button onclick="renderMermaid()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">ì‹œê°í™”í•˜ê¸°</button>
        <div class="flex gap-2">
          <button onclick="toggleTheme()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 text-sm">í…Œë§ˆ ë³€ê²½</button>
          <button onclick="clearDiagram()" class="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 text-sm">ì´ˆê¸°í™”</button>
        </div>
      </section>

      <section>
        <h3 class="text-sm font-semibold mb-2 text-gray-700">ìƒ˜í”Œ í…œí”Œë¦¿</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="loadTemplate('flowchart')"  class="bg-blue-100 text-blue-700  py-2 px-3 rounded-lg hover:bg-blue-200  text-sm">í”Œë¡œìš°ì°¨íŠ¸</button>
          <button onclick="loadTemplate('sequence')"  class="bg-green-100 text-green-700  py-2 px-3 rounded-lg hover:bg-green-200 text-sm">ì‹œí€€ìŠ¤</button>
          <button onclick="loadTemplate('gantt')"     class="bg-yellow-100 text-yellow-700 py-2 px-3 rounded-lg hover:bg-yellow-200 text-sm">ê°„íŠ¸ ì°¨íŠ¸</button>
          <button onclick="loadTemplate('pie')"       class="bg-pink-100 text-pink-700   py-2 px-3 rounded-lg hover:bg-pink-200   text-sm">íŒŒì´ ì°¨íŠ¸</button>
          <button onclick="loadTemplate('er')"        class="bg-purple-100 text-purple-700 py-2 px-3 rounded-lg hover:bg-purple-200 text-sm">ER ë‹¤ì´ì–´ê·¸ë¨</button>
          <button onclick="loadTemplate('journey')"   class="bg-indigo-100 text-indigo-700 py-2 px-3 rounded-lg hover:bg-indigo-200 text-sm">ì‚¬ìš©ì ì—¬ì •</button>
        </div>
      </section>
    </aside>

    <!-- ë¯¸ë¦¬ë³´ê¸° -->
    <section class="col-span-8 preview-container">
      <div class="preview-content"><div id="mermaidOutput" class="text-gray-400">ì—¬ê¸°ì— ë‹¤ì´ì–´ê·¸ë¨ì´ í‘œì‹œë¼</div></div>
    </section>
  </main>

  <!-- í™•ëŒ€/ì¶•ì†Œ + ë‹¤ìš´ë¡œë“œ ì»¨íŠ¸ë¡¤ -->
  <div class="action-panel flex flex-wrap gap-2">
    <button onclick="zoomOut()"  class="p-2 bg-gray-100 rounded hover:bg-gray-200" title="ì¶•ì†Œ">ï¼</button>
    <span   id="zoomLevel" class="px-3 py-2 bg-gray-100 rounded text-sm min-w-[70px] text-center">100%</span>
    <button onclick="zoomIn()"   class="p-2 bg-gray-100 rounded hover:bg-gray-200" title="í™•ëŒ€">ï¼‹</button>
    <button onclick="resetZoom()"class="p-2 bg-gray-100 rounded hover:bg-gray-200" title="ì›ë³¸">â—</button>
    <button onclick="downloadSvg()" class="p-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">SVG</button>
    <button onclick="downloadPng()" class="p-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">PNG</button>
  </div>

<script>
/* ========= ì „ì—­ ========= */
let currentZoom = 1;
let currentTheme = 'default';

/* ========= Mermaid ì´ˆê¸°í™” ========= */
mermaid.initialize({
  startOnLoad:false,
  theme:currentTheme,
  maxTextSize:50000,
  maxEdges:5000,
  htmlLabels:true,
  flowchart:{ htmlLabels:true,useMaxWidth:false,curve:'basis',rankSpacing:50,nodeSpacing:50,padding:15,wrap:false }
});

/* ========= Mermaid ë Œë” ========= */
async function renderMermaid(){
  const code = mermaidInput.value.trim();
  if(!code){ mermaidOutput.innerHTML='<span class="text-red-500">ì½”ë“œë¥¼ ì…ë ¥í•´ì¤˜!</span>'; return; }

  const temp = document.createElement('div');
  temp.style.position='absolute';
  temp.style.left='-9999px';
  temp.innerHTML = `<div class="mermaid">${code}</div>`;
  document.body.appendChild(temp);
  await mermaid.run({nodes:temp.querySelectorAll('.mermaid')});

  const svg = temp.querySelector('svg');
  if(!svg){ mermaidOutput.textContent='ë Œë”ë§ ì‹¤íŒ¨'; temp.remove(); return; }

  const pad = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--padding'));
  const box = svg.getBBox();
  svg.setAttribute('viewBox',`${box.x-pad} ${box.y-pad} ${box.width+pad*2} ${box.height+pad*2}`);
  svg.setAttribute('width', box.width+pad*2);
  svg.setAttribute('height',box.height+pad*2);
  svg.removeAttribute('style');

  mermaidOutput.innerHTML='';
  mermaidOutput.appendChild(svg.cloneNode(true));
  temp.remove();
  applyZoom();
}

/* ========= í™•ëŒ€/ì¶•ì†Œ ========= */
function applyZoom(){
  const svg = mermaidOutput.querySelector('svg'); if(!svg) return;
  svg.style.transform=`scale(${currentZoom})`;

  const w=parseFloat(svg.getAttribute('width'))||0;
  const h=parseFloat(svg.getAttribute('height'))||0;
  document.querySelector('.preview-content').style.minWidth = w*currentZoom+100+'px';
  document.querySelector('.preview-content').style.minHeight= h*currentZoom+100+'px';
  zoomLevel.textContent=`${Math.round(currentZoom*100)}%`;
}
function zoomIn(){  if(currentZoom<3){ currentZoom+=.25; applyZoom(); } }
function zoomOut(){ if(currentZoom>.25){ currentZoom-=.25; applyZoom(); } }
function resetZoom(){ currentZoom=1; applyZoom(); }

/* ========= í…Œë§ˆ í† ê¸€ ========= */
function toggleTheme(){
  const t=['default','dark','forest','neutral'];
  currentTheme=t[(t.indexOf(currentTheme)+1)%t.length];
  mermaid.initialize({startOnLoad:false,theme:currentTheme});
  renderMermaid();
}

/* ========= ì´ˆê¸°í™” ========= */
function clearDiagram(){
  mermaidInput.value='';
  mermaidOutput.textContent='ì—¬ê¸°ì— ë‹¤ì´ì–´ê·¸ë¨ì´ í‘œì‹œë¼';
  resetZoom();
}

/* ========= í…œí”Œë¦¿ ========= */
function loadTemplate(type){
  const T={
    flowchart:`graph TD
  A[ì‹œì‘] --> B{ì¡°ê±´ í™•ì¸}
  B -->|ì¡°ê±´ 1| C[í”„ë¡œì„¸ìŠ¤ A]
  B -->|ì¡°ê±´ 2| D[í”„ë¡œì„¸ìŠ¤ B]
  C --> E[ê²°ê³¼ ì²˜ë¦¬]
  D --> E
  E --> F[ì¢…ë£Œ]

  style A fill:#e1f5e1
  style F fill:#ffe1e1
  style B fill:#e1e5ff`,
    sequence:`sequenceDiagram
  participant ì‚¬ìš©ì
  participant ì„œë²„
  participant DB

  ì‚¬ìš©ì->>ì„œë²„: ë¡œê·¸ì¸ ìš”ì²­
  activate ì„œë²„
  ì„œë²„->>DB: ì‚¬ìš©ì ì¡°íšŒ
  activate DB
  DB-->>ì„œë²„: ì •ë³´ ë°˜í™˜
  deactivate DB
  ì„œë²„-->>ì‚¬ìš©ì: ì„±ê³µ
  deactivate ì„œë²„`,
    gantt:`gantt
  title í”„ë¡œì íŠ¸ ì¼ì •
  dateFormat  YYYY-MM-DD
  section ê¸°íš
  ìš”êµ¬ì‚¬í•­ ë¶„ì„     :done, a1, 2024-01-01, 7d
  ì„¤ê³„             :active, after a1, 5d
  section ê°œë°œ
  í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ   :crit, 2024-01-10, 10d
  ë°±ì—”ë“œ ê°œë°œ      :2024-01-12, 8d
  section í…ŒìŠ¤íŠ¸
  í†µí•© í…ŒìŠ¤íŠ¸      :2024-01-20, 5d`,
    pie:`pie title í”„ë¡œì íŠ¸ ì‹œê°„
  "ê¸°íš" : 20
  "ë””ìì¸" : 15
  "ê°œë°œ" : 40
  "í…ŒìŠ¤íŠ¸" : 15
  "ë°°í¬" : 10`,
    er:`erDiagram
  CUSTOMER ||--o{ ORDER : places
  ORDER ||--|{ LINE-ITEM : contains
  CUSTOMER { string name string custNumber string sector }
  ORDER { int orderNumber string deliveryAddress date orderDate }
  LINE-ITEM { string productCode int quantity float pricePerUnit }`,
    journey:`journey
  title ì‡¼í•‘ ì—¬ì •
  section ê²€ìƒ‰
    í™ˆí˜ì´ì§€ ë°©ë¬¸: 5: ì‚¬ìš©ì
    ê²€ìƒ‰: 4: ì‚¬ìš©ì
  section ê²°ì •
    ìƒì„¸ ë³´ê¸°: 5: ì‚¬ìš©ì
    ë¦¬ë·° í™•ì¸: 4: ì‚¬ìš©ì
    ì¥ë°”êµ¬ë‹ˆ: 5: ì‚¬ìš©ì
  section ê²°ì œ
    ì •ë³´ ì…ë ¥: 3: ì‚¬ìš©ì
    ì£¼ë¬¸ ì™„ë£Œ: 5: ì‚¬ìš©ì`
  };
  mermaidInput.value=T[type]; renderMermaid();
}

/* ========= ë‹¤ìš´ë¡œë“œ: SVG ========= */
function downloadSvg(){
  const svg = mermaidOutput.querySelector('svg'); if(!svg) return alert('ë¨¼ì € ì‹œê°í™”í•´');
  const cloned=svg.cloneNode(true); cloned.removeAttribute('style');
  const blob=new Blob([cloned.outerHTML],{type:'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='diagram.svg';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ========= ë‹¤ìš´ë¡œë“œ: PNG ========= */
async function downloadPng(){
  const svg = mermaidOutput.querySelector('svg'); if(!svg) return alert('ë¨¼ì € ì‹œê°í™”í•´');

  const { Canvg } = window.canvg || {}; // canvg UMD ë„¤ì„ìŠ¤í˜ì´ìŠ¤
  if(!Canvg) return alert('canvg ë¡œë“œ ì‹¤íŒ¨');

  const svgData = new XMLSerializer().serializeToString(svg);
  const { width, height } = svg.getBBox();
  const scale = 4;          // ì¶œë ¥ ë°°ìœ¨
  const canvas = document.createElement('canvas');
  canvas.width  = width  * scale;
  canvas.height = height * scale;

  const ctx = canvas.getContext('2d');
  const v   = await Canvg.fromString(ctx, svgData);
  await v.render();

  canvas.toBlob(blob=>{
    const url = URL.createObjectURL(blob);
    const a   = document.createElement('a');
    a.href=url; a.download='diagram.png';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
}

/* ========= ë¡œë“œì‹œ ìƒ˜í”Œ ========= */
window.onload=()=>loadTemplate('flowchart');
</script>
</body>
</html>
